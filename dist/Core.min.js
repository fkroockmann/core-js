/*
 * Copyright (c) 2011-2013 Lp digital system
 *
 * This file is part of BackBee.
 *
 * BackBee is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * BackBee is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with BackBee. If not, see <http://www.gnu.org/licenses/>.
 */
define("Core/Api",[],function(){"use strict";var e={},t={register:function(e,t){this.hasOwnProperty(e)||(this[e]=t)},set:function(t,n){this.Mediator.publish("api:set:"+t,n),e[t]=n},get:function(t){return e[t]},unset:function(t){e[t]=null,delete e[t]}};return t}),define("Core/Utils",["jquery","Core/Api"],function(e,t){"use strict";var n=function o(t){return this.dataContainer={},this.itemCount=0,this.idKey=null,this.maxEntry=null,this.onChange=function(){},this.onDestroy=function(){},this.onInit=function(){},this.onAdd=function(){},this.onReplace=function(){},this.onDelete=function(){},"function"!=typeof this.init&&(this.init=function(e){if(e&&!e.hasOwnProperty("idKey"))throw"SmartList:init if a config param is provided a config.idKey is expected";e=e||{},this.name=e.name||"list_"+(new Date).getTime();var t=e.data||{};this.onChange="function"==typeof e.onChange?e.onChange:this.onChange,this.onDestroy="function"==typeof e.onDestroy?e.onDestroy:this.onDestroy,e.idKey&&(this.idKey=e.idKey),this.onInit="function"==typeof e.onInit?e.onInit:this.onInit,this.onAdd="function"==typeof e.onAdd?e.onAdd:this.onAdd,this.onReplace="function"==typeof e.onReplace?e.onReplace:this.onReplace,this.onDelete="function"==typeof e.onDelete?e.onDelete:this.onDelete,e.maxEntry&&(this.maxEntry=parseInt(e.maxEntry,10)),this.setData(t),this.itemCount=this.getSize()}),o.prototype.setMaxEntry=function(e){this.maxEntry=e||null},o.prototype.set=function(t,n){if(this.idKey&&!e.isPlainObject(t))throw"SmartList:set item should be an object when and idKey is set";if(this.idKey&&e.isPlainObject(t)){if(!t.hasOwnProperty(this.idKey))throw"SmartList:set should have a key "+this.idKey;n=t,t=t[this.idKey]}if(!this.dataContainer.hasOwnProperty(t)){var i=this.itemCount+1;if(this.maxEntry&&i>this.maxEntry)return;this.itemCount=i}this.dataContainer[t]=n,this.onChange(this.dataContainer,this.name,n)},o.prototype.get=function(e){return this.dataContainer[e]||!1},o.prototype.destroy=function(){var e=this;this.dataContainer={},this.itemCount=0,this.onDestroy(e)},o.prototype.reset=function(){this.destroy()},o.prototype.getData=function(){return this.dataContainer},o.prototype.toArray=function(t){var n=this,i=[];return t?e.each(this.dataContainer,function(e){i.push(n.dataContainer[e])}):i=e.makeArray(this.dataContainer),i},o.prototype.replaceItem=function(e){if(!arguments.length)throw"SmartList:replaceItem expects one parameter";if(!e.hasOwnProperty(this.idKey))throw"SmartList:deleteItem [item] should have a ["+this.idKey+"] key";this.dataContainer[e[this.idKey]]=e,this.onReplace(this.dataContainer,this.name,e)},o.prototype.deleteItem=function(t){if(!arguments.length)throw"SmartList:replaceItem expects one parameter";if(!e.isPlainObject(t))throw"SmartList:deleteItem [item] should be a object";if(!t.hasOwnProperty(this.idKey))throw"SmartList:deleteItem [item] should have a ["+this.idKey+"] key";delete this.dataContainer[t[this.idKey]],this.itemCount=this.itemCount-1,this.onDelete(this.dataContainer,this.name,t)},o.prototype.deleteItemById=function(e){return this.dataContainer.hasOwnProperty(e)?(delete this.dataContainer[e],this.itemCount=this.itemCount-1,void this.onDelete(this.dataContainer,this.name,e)):!1},o.prototype.setData=function(t){var n,i=this;if(!t)throw"SmartList:setData data must be provided";if(e.isArray(t)){if(!this.idKey)throw"SmartList:setData idKey must be provided";e.each(t,function(e){n=t[e],n.hasOwnProperty(i.idKey)&&i.set(n)})}else this.dataContainer=t;this.onInit(this.dataContainer)},o.prototype.addData=function(t){var n,i=this,r=[];if(e.isArray(t)){if(!this.idKey)throw"SmartList:addData idKey must be provided";e.each(t,function(e){n=t[e],n.hasOwnProperty(i.idKey)&&(i.set(n),r.push(n))})}else this.dataContainer=e.extend(!0,this.dataContainer,t);this.onAdd(r)},o.prototype.getSize=function(){var e=this.toArray(!0);return e.length},this.init(t)},i=function(t,n){var i=new e.Deferred;return n?(t.splice(0,0,"require"),require(t,function(e){i.resolve.call(this,e)},function(e){i.reject(e)})):require(t,function(){i.resolve.apply(this,arguments)},function(e){i.reject(e)}),i.promise()},r=function(e){return e instanceof Object&&!(e instanceof Array)&&(e=Object.keys(e).map(function(t){return e[t]})),e};return t.register("SmartList",n),{SmartList:n,requireWithPromise:i,castAsArray:r}}),define("Core/ApplicationContainer",["jquery","jsclass","Core/Api"],function(e,t){"use strict";var n,i=null;return n=new JS.Class({initialize:function(){this.container=[]},register:function(n){e.isPlainObject(n)||t.exception("AppContainerException",6e4,"applicationInfos should be an object"),n.hasOwnProperty("name")||t.exception("AppContainerException",60001,"applicationInfos should have a name property"),this.container.push(n)},getByAppInfosName:function(t){var n=null;return e.each(this.container,function(e,i){return i.name===t?(n=i,!1):void(e+=1)}),n},reset:function(){this.container=[]}}),{getInstance:function(){return i||(i=new n),i}}}),define("Core/ControllerManager",["require","Core/Api","Core/ApplicationContainer","jquery","jsclass","Core/Utils"],function(e){"use strict";var t=e("Core/Api"),n=e("jquery"),i=e("Core/Utils"),r=e("Core/ApplicationContainer"),o={},s={},a={},c=null,u=function(e,n){t.exception("ControllerManagerException",e,n)},p=new JS.Class({initialize:function(){this.state=0,this.enabled=!1;var e=r.getInstance().getByAppInfosName(this.appName);this.mainApp=e.instance},handleImport:function(){var e=new n.Deferred;return n.isArray(this.config.imports)&&this.config.imports.length?i.requireWithPromise(this.config.imports).done(e.resolve).fail(function(t){var n={method:"ControllerManager:handleImport",message:t};e.reject(n)}):e.resolve(),e.promise()},beforeCall:function(r){var o=new n.Deferred,s=this;return void 0!==this.config.define&&void 0!==this.config.define[r]?i.requireWithPromise(this.config.define[r]).then(function(){o.resolve.call(s,e)},function(e){t.exception.silent("ControllerManagerException",15007,"Something goes worng during the depencies loading of "+r,{service:r,reason:e,depencies:s.config.define[r]}),o.reject.call(s)}):o.resolve.call(s,!1),o.promise()},onEnabled:function(){this.enabled=!0},onDisabled:function(){this.enabled=!1},invoke:function(e,t){var n=e+"Action";"function"!=typeof this[n]&&u(15001,n+" Action Doesnt Exists in "+this.getName()+" Controller"),"function"!=typeof this[n]&&u(15001,n+" Action Doesnt Exists in "+this.getName()+" Cotroller");try{this[n].apply(this,t)}catch(i){u(15002,"Error while executing ["+n+"] in "+this.getName()+" controller with message: "+i)}}}),h=function(e){e!==c&&(c&&c.onDisabled(),c=e,c.onEnabled())},l=function(e){var t="",n=-1;return"string"==typeof e&&(n=e.indexOf("Controller")),-1!==n&&(e=e.substring(0,n),t=e.toLowerCase()+".controller"),0===t.length&&u(15004,"Controller name do not respect {name}Controller style declaration"),t},f=function(t,n,i){var r,s=t+"."+l(n);r=new o[t][n],a[s]=r,r.handleImport().then(function(){r.onInit(e),h(r),i.resolve(r)})},d=function(e){var t,n=l(e);return n=n.split("."),t=n[0]},g=function(e,t){var n=t.appName,i=d(e),r={};!1===t.hasOwnProperty("appName")&&u(15003,"Controller should be attached to an App"),t.hasOwnProperty("initialize")&&delete t.initialize,r=new JS.Class(p,t),r.define("initialize",function(e){return function(){this.callSuper(e)}}(t.config)),r.define("getName",function(e){return function(){return e}}(e)),o[n]||(o[n]={}),o[n][e]=r,i=i.toLowerCase(),s[n+":"+i]={constructor:r,originalName:e}},y=function(e,t){var r=e+"."+l(t),s=n.Deferred(),c="";return e&&"string"==typeof e||u(15005,"appName have to be defined as String"),c=a[r],c?(h(c),s.resolve(c)):o.hasOwnProperty(e)&&"function"==typeof o[e][t]?f(e,t,s):i.requireWithPromise([r]).done(function(){f(e,t,s)}).fail(s.reject),s.promise()},m=function(e,t){var r,o,a=new n.Deferred,c=e+"."+t+".controller";return e&&"string"==typeof e||u(15005,"appName have to be defined as String"),e&&"string"==typeof e||u(15006,"shortControllerName have to be defined as String"),(o=s[e+":"+t])?y(e,o.originalName):(i.requireWithPromise([c]).done(function(){return r=s[e+":"+t].originalName,y(e,r).done(a.resolve).fail(a.reject)}).fail(a.reject),a.promise())},v=function(e){return o.hasOwnProperty(e)?o[e]:void u(15006,"Controller Not Found")},C={registerController:g,loadController:y,loadControllerByShortName:m,getAppControllers:v,getAllControllers:function(){return o}};return t.register("ControllerManager",C),C}),define("Core/ApplicationManager",["require","BackBone","jsclass","jquery","underscore","Core/Utils","Core/ApplicationContainer","Core/Api","Core/ControllerManager"],function(e){"use strict";var t=e("jquery"),n=e("underscore"),i=e("Core/Api"),r=e("BackBone"),o=e("Core/Utils"),s=e("Core/ControllerManager"),a={},c=null,u=null,p={},h=e("Core/ApplicationContainer").getInstance(),l=new JS.Class({initialize:function(e){this.config={},this.state=0,n.extend(this,r.Events),this.config=t.extend(!0,this.config,e)},getMainRoute:function(){return this.config.mainRoute},exposeMenu:function(){},dispatchToController:function(e,i,r){var o=new t.Deferred;return s.loadController(this.getName(),e).done(function(e){try{r=n.rest(r),e.invoke(i,r)}catch(t){o.reject(t)}}).fail(function(e){o.reject(e.message)}),o.promise()},invokeControllerService:function(e,n,r){var o,a=new t.Deferred,c=this;return s.loadControllerByShortName(this.getName(),e).done(function(e){try{o=n+"Service",e.beforeCall(o).then(function(t){t&&r.unshift(t);try{a.resolve(e[o].apply(e,r))}catch(n){i.exception.silent("InvokeServiceException",15008,"Something goes worng during the service "+o+" execution",{controller:c.getName(),service:o,error:n})}},function(){a.resolve(e[o].apply(e,r))})}catch(t){a.reject(t)}}).fail(function(e){a.reject(e)}),a.promise()},setControllerMng:function(e){return e},onInit:function(){},onStart:function(){this.trigger(this.getName()+":onStart")},onStop:function(){},onResume:function(){},onError:function(e){i.exception.silent("AbstractApplicationException",1,"error in["+this.name+"] application",{error:e})}}),f=function(e,t){if("string"!=typeof e)throw"ApplicationManager :appname should be a string";if("object"!=typeof t)throw"ApplicationManager : appDef Is undefined";var n=new JS.Class(l,t);n.define("getName",function(e){return function(){return this.name=e,e}}(e)),a.hasOwnProperty(e)&&i.exception("ApplicationManagerException",50007,"An application named ["+e+"] already exists."),a[e]=n},d=function(e){var n=new t.Deferred;return o.requireWithPromise(e).done(function(){p.trigger("routesLoaded"),n.resolve.apply(this,arguments)}).fail(function(e){n.reject(e)})},g=function(e,n){var r,o=new t.Deferred,s=h.getByAppInfosName(e),u=a[e];try{if(n=n||{},c&&c.getName()===e)o.resolve(c);else{if(s)c.onStop(),s.instance.onResume(),r=s.instance;else{if(!u)return y(e,n);r=new u(n),s={instance:r,name:e},c&&c.onStop(),h.register(s),s.instance.onInit(),s.instance.onStart(),r=s.instance}c=r,o.resolve(c)}}catch(p){i.exception.silent("ApplicationManagerException",500013,"An exception as been caught during "+e+" launching",{error:p})}return o.promise()},y=function(e,n,i){var r=new t.Deferred,s="boolean"==typeof i?i:!0,a=["app."+e];return o.requireWithPromise(a).done(function(){s?g(e,n).done(r.resolve):r.resolve.apply(arguments)}).fail(function(){r.reject("Application["+a+"] can't be found")}),r.promise()},m=function(){var e=u.applications[u.active]||{};return e.hasOwnProperty("config")&&(e=e.config),y(u.active,e).then(function(e){i.Mediator.publish("on:application:ready",e),p.trigger("appIsReady",e)})},v=function(){c=null,u=null,p.off(),h.reset()},C=function(e){p.trigger("appError",{reason:e})},w=function(e){e&&t.isPlainObject(e)||i.exception("ApplicationManagerException",50001,"init expects a parameter one to be an object.");var r=[],s="",a=[],c=[],p=this;u=e,u.hasOwnProperty("appPath")||i.exception("ApplicationManagerException",50002,"InvalidAppConfig [appPath] key is missing"),u.hasOwnProperty("applications")||i.exception("ApplicationManagerException",50003,"InvalidAppConfig [applications] key is missing"),u.hasOwnProperty("active")||i.exception("ApplicationManagerException",50004,"InvalidAppConfig [active] key is missing"),t.isPlainObject(e.applications)||i.exception("ApplicationManagerException",50005,"InvalidAppConfig [applications] should be an object"),0===n.size(u.applications)&&i.exception("ApplicationManagerException",50006,"InvalidAppConfig at least one application config should be provided"),t.each(u.applications,function(e,n){c.push(u.appPath+"/"+e+"/main.js"),s=e+".routes",a.push("app."+e),n.config.hasOwnProperty("routePath")&&"string"==typeof n.config.routePath&&(s=n.config.routePath),r.push(s),n.hasOwnProperty("scope")&&t.each(n.scope,function(t,n){i.Scope.subscribe(t,function(){n.open&&p.invokeService(e+"."+n.open)},function(){n.open&&p.invokeService(e+"."+n.close)})})}),o.requireWithPromise(c).then(t.proxy(d,null,r)).done(m).fail(C)},b=function(e,t){t=t||{},e&&"string"==typeof e||i.exception("ApplicationManagerException",50009,"Application.invoke actionInfos should be a string"),e=e.split(":"),3!==e.length&&i.exception("ApplicationManagerException",50010,"Invalid actionInfos. Valid format {appname}:{controllerName}:{controllerAction}");var n=g(e[0]);n.fail(function(e){p.trigger("appError",{reason:e})}),n.done(function(n){n.dispatchToController(e[1],e[2],t).fail(function(e){p.trigger("appError",{reason:e})})})},x=function(e,t){t=t||{},"string"!=typeof e&&i.exception("ApplicationManagerException",50009,"appName should be a string and config should be an object");var n,r,o=null;if(r=h.getByAppInfosName(e),r&&r.hasOwnProperty("instance"))o=r.instance;else{if(n=a[e],!n)return o;o=new n(t),r={instance:o,name:e},h.register(r)}return o},A=function(e){var n,r,o,s,a,c,u=new t.Deferred;return e&&"string"==typeof e||i.exception("ApplicationManagerException",50011,"invokeService expects parameter one to be a string."),s=t.merge([],arguments),s.shift(),n=e.split("."),3!==n.length&&i.exception("ApplicationManagerException",50012,""),r=n[0],o=n[2],c=n[1],a=x(r),a?a.invokeControllerService(c,o,s).done(u.resolve).fail(u.reject):y(r,{},!1).done(function(){a=x(r),a.invokeControllerService(c,o,s).done(u.resolve).fail(u.reject)}).fail(function(e){p.trigger("appError",{reason:e})}),u.promise()};return p={registerApplication:f,invoke:b,invokeService:A,launchApplication:g,init:w,reset:v},n.extend(p,r.Events),i.register("ApplicationManager",p),p}),define("Core/Mediator",["Core/Api"],function(e){"use strict";var t=function(e,t){this.callback=e,this.context=t},n=function(){this.topics={},this.publicated={},this.subscribe_once={}};t.prototype.execute=function(){void 0===this.context?this.callback.apply(void 0,arguments):this.callback.apply(this.context,arguments)},n.prototype.subscribe=function(e,n,i){var r=new t(n,i);this.topics.hasOwnProperty(e)||(this.topics[e]=[]),this.topics[e].push(r),this.publicated.hasOwnProperty(e)&&r.execute.apply(r,this.publicated[e].args)},n.prototype.subscribeOnce=function(e,t,n){this.subscribe_once.hasOwnProperty(e)||(this.subscribe_once[e]=[]),this.subscribe_once[e].push(t),this.subscribe(e,t,n)},n.prototype.unsubscribe=function(e,t){var n;if(this.topics.hasOwnProperty(e))for(n=0;n<this.topics[e].length;n+=1)this.topics[e][n].callback===t&&this.topics[e].splice(n,1)},n.prototype.publish=function(){var t,n,i=Array.prototype.slice.call(arguments),r=i.shift();if(this.topics.hasOwnProperty(r))for(t=0;t<this.topics[r].length;t+=1){n=this.topics[r][t].callback;try{this.topics[r][t].execute.apply(this.topics[r][t],i)}catch(o){e.exception.silent("MediatorException",12201,'Mediator caught an error when the topic : "'+r+'" was published.',{topic:r,context:this.topics[r][t].context,callback:this.topics[r][t].callback,args:i,error:o})}if(this.subscribe_once.hasOwnProperty(r))for(t=0;t<this.subscribe_once[r].length;t+=1)this.subscribe_once[r][t]===n&&this.unsubscribe(r,n)}},n.prototype.persistentPublish=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();this.publish.apply(this,arguments),this.publicated[t]={args:e}},n.prototype.removePublish=function(e){this.publicated[e]=null,delete this.publicated[e]},e.register("Mediator",new n)}),define("Core/RouteManager",["jquery","Core/Api","BackBone","Core/ApplicationManager","jsclass"],function(e,t,n,i){"use strict";var r={},o=new JS.Class({initialize:function(){var e=n.Router.extend({execute:function(e,t){"function"==typeof e&&e.apply(this,t)}});this.routes={},this.mainRouter=new e({}),this.handleApplicationLinks()},handleApplicationLinks:function(){var n,i,o=this;e("body").delegate("a","click",function(s){var a=e(this).data("action");"string"==typeof a&&(s.preventDefault(),i=r[a],e.isPlainObject(i)||t.exception("RouteManagerException",500,"handleApplicationLinks route "+a+" can't be found"),n=o.buildLink(a),o.navigate(n))})},buildLink:function(n,i){var o,s;return!1===r.hasOwnProperty(n)&&t.exception("RouteManagerException",500,"buildLink routeInfos can't be found"),o=r[n],i=i||o.defaults,s=o.url,o.hasOwnProperty("defaults")&&e.each(o.defaults,function(e,t){s=s.replace(e,t)}),s},navigate:function(e,t,n){var i={trigger:t||!0,replace:n||!0};void 0!==e&&this.mainRouter.navigate(e,i)},genericRouteHandler:function(n,r){var o=e.merge([],arguments);o.pop(),t.Mediator.publish("on:route:handling",r,n),i.invoke(n,o)},registerRoute:function(t){var n=t.completeName.split(":");this.mainRouter.route(t.url,t.completeName,e.proxy(this.genericRouteHandler,this,n[0]+":"+t.action,t.url))}}),s=new o,a={initRouter:function(e){return e=e||{},n.history.start(e),this},registerRoute:function(n,i){var o=i.routes,a="",c="";i.hasOwnProperty("routes")||t.exception("RouteManagerException",500,"A routes key must be provided"),e.isPlainObject(i.routes)||t.exception("RouteManagerException",500,"Routes must be an object"),"string"==typeof i.prefix&&(a=i.prefix),e.each(o,function(i,o){e.isPlainObject(o)||t.exception("RouteManagerException",500,i+" route infos must be an object"),o.hasOwnProperty("url")||t.exception("RouteManagerException",500,i+" route infos must have `url` property"),o.hasOwnProperty("action")||t.exception("RouteManagerException",500,i+" route infos must have `action` property"),0!==a.length&&(c=0===o.url.indexOf("/")?o.url.substring(1):o.url,o.url=a+"/"+c),o.completeName=n+":"+i,r[o.completeName]=o,s.registerRoute(o)})},navigate:function(e,t,n){this.navigateByPath(e,t,n)},navigateByPath:function(e,t,n){s.navigate(e,t,n)},navigateByName:function(e,t,n){this.navigateByPath(s.buildLink(e),t,n)}};return t.register("RouteManager",a),a}),define("Core/Exception",["Core/Api","jsclass"],function(){"use strict";var e=new JS.Class({Api:require("Core/Api"),initialize:function(e,t,n,i){this.name=e,this.message=t,this.code=n,this.params=i,this.stack=this.getStack()},getStack:function(){var e,t,n=new Error(this.name),i=[];if(n.stack){e=n.stack.split("\n"),i=e.slice(5);for(t in i)i.hasOwnProperty(t)&&(i[t]=this.parseStackLine(i[t]))}return i},pushError:function(e,t){void 0===t.get("errors")&&t.set("errors",[]),t.get("errors").push(e),t.set("lastError",e)},parseStackLine:function(e){var t=/^\s*at\s+([\w\W]+)\(([\w\W]+\.js)[\w\W]*:(\d+):(\d+)\)/i,n=t.exec(e),i=n&&n[1]?n[1]:e,r=n&&n[2]?n[2]:null,o=n&&n[3]?n[3]:null,s=n&&n[4]?n[4]:null;return{column:s,line:o,file:r,call:i}}}),t=function(t,n,i,r){t=t||"UnknowException",n=n||500,i=i||"No description found for this exception.",r=r||{};var o=new e(t,i,n,r);throw o.pushError(o,o.Api),"Error n "+n+" "+t+": "+i};t.silent=function(e,n,i,r){try{t(e,n,i,r)}catch(o){return o}},require("Core/Api").register("exception",t)}),define("Core/Scope",["Core/Api","underscore"],function(e,t){"use strict";var n=function(){this.scopes=[],e.Mediator.subscribeOnce("on:application:ready",function(){e.Mediator.persistentPublish("scope:global:opening")})},i=function(t,n){var i;for(i=0;i<t.length;i+=1)e.Mediator.publish(n===!0?"scope:"+t[i].toLowerCase()+":opening":"scope:"+t[i].toLowerCase()+":closing")},r=function(t){var n;for(n=0;n<t.length;n+=1)"string"!=typeof t[n]&&e.exception("ScopeException",12101,"All scope have to be a string.")};n.prototype.register=function(){var e=t.difference(arguments,this.scopes),n=t.difference(this.scopes,arguments);r(arguments),i(n,!1),i(e,!0),this.scopes=t.difference(this.scopes,n),this.scopes=t.union(this.scopes,e)},n.prototype.open=function(e){var n=t.indexOf(this.scopes,e);r([e]),-1===n&&(i([e],!0),this.scopes.push(e))},n.prototype.close=function(e){var n=t.indexOf(this.scopes,e);r([e]),-1!==n&&(i([e],!1),this.scopes=t.without(this.scopes,e))},n.prototype.subscribe=function(n,i,r){var o=t.indexOf(this.scopes,n.toLowerCase());if(("string"!=typeof n||"function"!=typeof i||"function"!=typeof r)&&e.exception("ScopeException",12102,"Scope subscription was incorrect."),-1!==o)try{i.apply(void 0)}catch(s){e.exception.silent("ScopeException",12103,'Error while running Opening callback in scope "'+n+'"" with message: '+s)}e.Mediator.subscribe("scope:"+n.toLowerCase()+":opening",i),e.Mediator.subscribe("scope:"+n.toLowerCase()+":closing",r)},e.register("Scope",new n)}),define("Core/Config",["require","Core/Api"],function(e){"use strict";var t=e("Core/Api"),n={},i=function(e){var n;for(n in e)if(e.hasOwnProperty(n)&&t.hasOwnProperty(n))try{t[n].init(e[n])}catch(i){t.exception.silent("CoreConfigurationException",12300,"Config injection fail for "+n+" core object with message : "+i)}},r=function(e){var t;for(t in e)e.hasOwnProperty(t)&&"object"==typeof e[t]&&null!==e[t]&&r(e[t]);Object.freeze(e)},o=function(e){e.hasOwnProperty("core")&&(i(e.core),delete e.core),n=e,r(n)},s=function(e,t){var n=e.pop();return t.hasOwnProperty(n)?e.length>0?s(e,t[n]):t[n]:void 0},a=function(e){var t=e.split(":");return s(t.reverse(),n)};t.register("initConfig",o),t.register("config",a)}),function(){"use strict";define("Core",["Core/Api","Core/ApplicationManager","Core/Mediator","Core/RouteManager","Core/ControllerManager","Core/Utils","Core/Exception","Core/Scope","Core/Config"],function(e){return Object.freeze(e)})}(),define("Core/DriverHandler",["underscore","jquery","jsclass"],function(e,t){"use strict";var n=new JS.Class({AVAILABLE_ACTIONS:["create","read","update","delete","patch","link"],drivers:{},defaultDriverId:null,mappings:{},hasDriver:function(t){return e.contains(e.keys(this.drivers),t)},addDriver:function(e,t,n){return!1===this.hasDriver(e)&&(this.drivers[e]=t),(!0===n||null===this.defaultDriverId)&&this.defaultDriver(e),this},getDriver:function(e){var t=null;return this.hasDriver(e)&&(t=this.drivers[e]),t},defaultDriver:function(e){return!0===this.hasDriver(e)&&(this.defaultDriverId=e),this},addActionDriverMapping:function(e,t){var n;if(!0===Array.isArray(t))for(n in t)t.hasOwnProperty(n)&&(n=t[n],!0===this.isValidActionDriverMapping(n)&&(!1===this.mappings.hasOwnProperty(e)&&(this.mappings[e]={}),this.mappings[e][n.action]=n));return this},isValidActionDriverMapping:function(t){var n;if(!1===t.hasOwnProperty("action")||!1===t.hasOwnProperty("drivers"))return!1;if(!1===e.contains(this.AVAILABLE_ACTIONS,t.action))return!1;if(!1===Array.isArray(t.drivers)||0===t.drivers.length)return!1;for(n in t.drivers)if(t.drivers.hasOwnProperty(n)&&(n=t.drivers[n],!1===this.hasDriver(n)))return!1;return!0},create:function(e,t){return this.doGenericAction("create",e,{data:t})},read:function(e,t,n,i,r){return this.doGenericAction("read",e,this.formatData({},t,n,i,r))},update:function(e,t,n,i,r,o){return this.doGenericAction("update",e,this.formatData(t,n,i,r,o))},"delete":function(e,t,n,i,r){return this.doGenericAction("delete",e,this.formatData({},t,n,i,r))},link:function(e,t,n,i,r,o){return this.doGenericAction("link",e,this.formatData(t,n,i,r,o))},patch:function(e,t,n,i,r,o){return this.doGenericAction("patch",e,this.formatData(t,n,i,r,o))},formatData:function(e,t,n,i,r){return{data:e,criteria:t||{},orderBy:n||{},start:i||0,limit:r||null}},doGenericAction:function(e,n,i){var r,o=this.getDriversByTypeAndAction(n,e),s=t.Deferred(),a=function(e,t){s.resolve(e,t)},c=function(e){console.log(e),s.reject(e)};for(r in o)o.hasOwnProperty(r)&&this.drivers[o[r]].handle(e,n,i).done(a).fail(c);return s.promise()},getDriversByTypeAndAction:function(e,t){var n=null;return this.mappings.hasOwnProperty(e)&&this.mappings[e].hasOwnProperty(t)&&(n=this.mappings[e][t].drivers),null===n&&(n=[this.defaultDriverId]),n},reset:function(){this.drivers={},this.defaultDriverId=null,this.mappings={}}});return new JS.Singleton(n)}),define("Core/Renderer",["require","nunjucks","Core","jquery","Core/Utils","jsclass"],function(e,t,n){"use strict";var i,r=e("jquery"),o={},s=new JS.Class({initialize:function(){var e=o.error_tpl||"<p>Error while loading template</p>",n=o.placeholder||"<p>Loading...</p>";this.env=t.configure({watch:!1}),this.engine=t,this.render_action="html",this.error_msg=r(e).clone(),this.placeholder=r(n),this.functions={}},getEngine:function(){return this.engine},addFilter:function(e,t,n){this.env.addFilter(e,t,n)},addFunction:function(e,t){"function"==typeof t&&(this.functions[e]=t)},mergeParameters:function(e){var t;e||(e={});for(t in this.functions)this.functions.hasOwnProperty(t)&&(e[t]=this.functions[t]);return e},asyncRender:function(t,n,i){if(n=this.mergeParameters(n),i=i||{},i.placeholder=i.placeholder||this.placeholder,i.action=i.action||"html",!t||"string"!=typeof t)throw"Renderer:asyncRender [path] parameter should be a string";return e("Core/Utils").requireWithPromise(["text!"+t]).then(r.proxy(this.onTemplateReady,this,i,n),r.proxy(this.errorRenderer,this,i)),r(i.placeholder)},render:function(e,t){t=this.mergeParameters(t);try{return this.engine.renderString(e,t)}catch(i){n.exception("RenderException",500,i.message,{engineException:i,template:e,params:t})}},errorRenderer:function(e){r(e.placeholder)[e.action](this.error_msg)},onTemplateReady:function(e,t,n){r(e.placeholder)[e.action](this.engine.renderString(n,t))}}),a=function(){return void 0===i&&(i=new s),i},c=function(e){o=e},u=function(e){return function(t){return function(){var n=Array.prototype.slice.call(arguments);return t[e].apply(t,n)}}(a())},p={init:c,getEngine:u("getEngine"),render:u("render"),asyncRender:u("asyncRender"),addFilter:u("addFilter"),addFunction:u("addFunction")};return p}),define("Core/Request",["jsclass"],function(){"use strict";var e=new JS.Class({initialize:function(){this.url="",this.method="GET",this.data=null,this.headers={"Content-Type":"application/x-www-form-uriencoded"}},setUrl:function(e){return this.url=e,this},setMethod:function(e){return this.method=e.toUpperCase(),this},setData:function(e){return this.data=e,this},setHeaders:function(e){return this.headers=e,this},addHeader:function(e,t){return this.headers[e]=t,this},setContentType:function(e){return this.addHeader("Content-Type",e),this},getUrl:function(){return this.url},getContentType:function(){return this.headers["Content-Type"]},getMethod:function(){return this.method},getData:function(){return this.data},getHeader:function(e){return this.headers[e]||null},getHeaders:function(){return this.headers}});return e}),define("Core/Response",["jsclass"],function(){"use strict";var e=new JS.Class({initialize:function(){this.headers={},this.data="",this.rawData="",this.status=200,this.statusText="",this.errorText=""},getHeaders:function(){return this.headers},getHeader:function(e){return this.headers[e]||null},getData:function(){return""===this.data?this.rawData:this.data},getRawData:function(){return this.rawData},getStatus:function(){return this.status},getStatusText:function(){return this.statusText},getErrorText:function(){return this.errorText},getUidFromLocation:function(){var e,t,n=this.getHeader("Location");return null===n?null:(t=new RegExp("[/]([a-f0-9]{32}$)"),e=t.exec(n),e[1])},getRangeFrom:function(){var e,t=this.getHeader("Content-Range");return null===t?null:(e=t.split("-"),void 0===e[0]?null:parseInt(e[0],10))},getRangeTo:function(){var e,t,n=this.getHeader("Content-Range");return null===n?null:(e=n.split("/"),void 0===e[0]?null:(t=e[0].split("-"),void 0===t[1]?null:parseInt(t[1],10)))},getRangeTotal:function(){var e,t=this.getHeader("Content-Range");return null===t?null:(e=t.split("/"),void 0===e[1]?null:parseInt(e[1],10))},setHeaders:function(e){return this.headers=e,this},addHeader:function(e,t){return this.headers[e]=t,this},setData:function(e){return this.data=e,this},setRawData:function(e){return this.rawData=e,this},setStatus:function(e){return this.status=e,this},setStatusText:function(e){return this.statusText=e,this},setErrorText:function(e){return this.errorText=e,this}});return e}),define("Core/RequestHandler",["Core/Api","jquery","underscore","BackBone","Core/Response","jsclass"],function(e,t,n,i,r){"use strict";var o=new JS.Class({initialize:function(){n.extend(this,i.Events)},send:function(n){var i=this,r=t.Deferred();return null!==n&&(e.Mediator.publish("request:send:before",n),t.ajax({url:n.getUrl(),type:n.getMethod(),data:n.getData(),headers:n.getHeaders()}).done(function(t,n,o){var s=i.buildResponse(o.getAllResponseHeaders(),t,o.responseText,o.status,n,"");e.Mediator.publish("request:send:done",s),r.resolve(s.getData(),s)}).fail(function(t,n,o){var s=i.buildResponse(t.getAllResponseHeaders(),"",t.responseText,t.status,n,o);e.Mediator.publish("request:send:fail",s),r.reject(s.getData(),s)})),r.promise()},buildResponse:function(e,t,n,i,o,s){var a=new r;return this.buildHeaders(a,e),a.setData(t),a.setRawData(n),a.setStatus(i),a.setStatusText(o),a.setErrorText(s),a},buildHeaders:function(e,t){var n,i,r,o,s,a;n=t.split("\r");for(s in n)n.hasOwnProperty(s)&&(i=n[s],a=i.indexOf(":"),-1!==a&&(r=i.substring(0,a).trim(),o=i.substring(a+1).trim(),e.addHeader(r,o)))}});return new JS.Singleton(o)}),define("Core/RestDriver",["Core/Request","Core/RequestHandler","URIjs/URI","Core","jsclass"],function(e,t,n,i){"use strict";var r=new JS.Class({initialize:function(){this.baseUrl="",this.request=null},setBaseUrl:function(e){this.baseUrl=e},handle:function(r,o,s){var a,c=new n(this.baseUrl);return this.request=new e,this.request.headers={},this.request.setContentType("application/json"),this.request.addHeader("Accept","application/json"),c.segment(o),"read"===r?(this.request.setMethod("GET"),this.computeCriteria(c,s)):"update"===r||"patch"===r||"link"===r||"delete"===r?(this.request.setMethod("update"===r?"put":r),this.computeCriteria(c,s),s.hasOwnProperty("data")&&this.request.setData("patch"===r?this.computePatchOperations(s.data):s.data)):"create"===r&&(this.request.setMethod("POST"),this.computeCriteria(c,s),s.hasOwnProperty("data")&&this.request.setData(s.data)),s.hasOwnProperty("limit")&&null!==s.limit&&(a=(s.hasOwnProperty("start")?s.start:"0")+","+s.limit,this.request.addHeader("Range",a)),this.computeOrderBy(c,s),this.request.setUrl(c.normalize().toString()),null!==this.request.getData()&&this.request.setData(JSON.stringify(this.request.getData())),i.Mediator.publish("rest:send:before",this.request),t.send(this.request)},computeCriteria:function(e,t){var n,i=t.hasOwnProperty("criteria")?t.criteria:null;if(null===i)return this;for(n in i)i.hasOwnProperty(n)&&("uid"===n||"id"===n?e.segment(i[n].toString()):e.addSearch(n+("object"==typeof i[n]?"[]":""),i[n]));return this},computeOrderBy:function(e,t){var n;if(t.hasOwnProperty("orderBy")&&"object"==typeof t.orderBy)for(n in t.orderBy)t.orderBy.hasOwnProperty(n)&&e.addSearch("order_by["+n+"]",t.orderBy[n]);return this},computePatchOperations:function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push({op:"replace",path:"/"+t,value:e[t]});return n}}),o=new r;return{handle:function(e,t,n){return o.handle(e,t,n)},setBaseUrl:function(e){return o.setBaseUrl(e),this}}});
//# sourceMappingURL=Core.min.js
//# sourceMappingURL=Core.min.js.map